<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>📊 Dashboard GA4 Reports</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        color: #333;
        background: #f5f5f5;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .header h1 {
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .stat-card h3 {
        color: #7f8c8d;
        font-size: 14px;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      .stat-card .number {
        font-size: 32px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .tabs {
        display: flex;
        background: white;
        border-radius: 10px 10px 0 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .tab {
        flex: 1;
        padding: 15px 20px;
        background: #ecf0f1;
        border: none;
        cursor: pointer;
        transition: background 0.3s;
      }

      .tab.active {
        background: #3498db;
        color: white;
      }

      .tab:hover {
        background: #34495e;
        color: white;
      }

      .content {
        background: white;
        padding: 30px;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        min-height: 400px;
      }

      .url-item {
        border-bottom: 1px solid #ecf0f1;
        padding: 20px 0;
      }

      .url-item:last-child {
        border-bottom: none;
      }

      .url-title {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 16px;
      }

      .url-stats {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      .url-stat {
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 14px;
      }

      .chart-container {
        margin-top: 15px;
        height: 150px;
        position: relative;
      }

      .execution-item {
        border-left: 4px solid #3498db;
        padding: 15px 20px;
        margin-bottom: 15px;
        background: #f8f9fa;
        border-radius: 0 5px 5px 0;
      }

      .execution-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .loading {
        text-align: center;
        padding: 50px;
        color: #7f8c8d;
      }

      .error {
        background: #e74c3c;
        color: white;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }

      .success {
        color: #27ae60;
      }

      .warning {
        color: #f39c12;
      }

      .last-value {
        font-size: 12px;
        color: #7f8c8d;
        margin-top: 5px;
      }

      @media (max-width: 768px) {
        .stats-grid {
          grid-template-columns: 1fr;
        }

        .tabs {
          flex-direction: column;
        }

        .url-stats {
          flex-direction: column;
          gap: 10px;
        }

        .execution-meta {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>📊 Dashboard GA4 Reports</h1>
        <p>Visualización de datos consolidados de Google Analytics 4</p>
        <p>
          <small>Última actualización: <span id="lastUpdate">Cargando...</span></small>
        </p>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <h3>Ejecuciones</h3>
          <div class="number" id="totalExecutions">-</div>
        </div>
        <div class="stat-card">
          <h3>URLs Únicas</h3>
          <div class="number" id="totalUrls">-</div>
        </div>
        <div class="stat-card">
          <h3>Período</h3>
          <div class="number" id="period" style="font-size: 18px">-</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('urls')">🔗 URLs</button>
        <button class="tab" onclick="showTab('executions')">📋 Ejecuciones</button>
        <button class="tab" onclick="showTab('api')">🔌 API</button>
      </div>

      <div class="content">
        <div id="urlsContent">
          <div class="loading">Cargando datos de URLs...</div>
        </div>

        <div id="executionsContent" style="display: none">
          <div class="loading">Cargando historial de ejecuciones...</div>
        </div>

        <div id="apiContent" style="display: none">
          <h3>🔌 Endpoints de la API</h3>
          <p>Puedes acceder a los datos mediante estos endpoints:</p>
          <ul style="margin: 20px 0; padding-left: 20px">
            <li><strong>GET /api/stats</strong> - Estadísticas generales</li>
            <li><strong>GET /api/urls</strong> - Resumen por URLs</li>
            <li><strong>GET /api/executions</strong> - Historial de ejecuciones</li>
            <li><strong>GET /api/execution/:id</strong> - Detalle de ejecución específica</li>
            <li><strong>GET /api/url/:urlPath</strong> - Datos de URL específica</li>
            <li><strong>GET /api/raw</strong> - Datos completos en JSON</li>
            <li><strong>POST /api/trigger-report</strong> - Ejecutar reporte manualmente</li>
          </ul>

          <h4>Ejemplos:</h4>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0">
            <code>curl http://localhost:3000/api/stats</code><br />
            <code>curl http://localhost:3000/api/urls</code><br />
            <code>curl -X POST http://localhost:3000/api/trigger-report</code>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentTab = 'urls';
      let charts = {};

      // Función para cambiar de pestaña
      function showTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');

        document.querySelectorAll('[id$="Content"]').forEach(content => {
          content.style.display = 'none';
        });
        document.getElementById(tabName + 'Content').style.display = 'block';

        currentTab = tabName;
      }

      // Función para cargar estadísticas
      async function loadStats() {
        try {
          const response = await fetch('/api/stats');
          const data = await response.json();

          document.getElementById('totalExecutions').textContent = data.totalEjecuciones;
          document.getElementById('totalUrls').textContent = data.urlsUnicas;
          document.getElementById('lastUpdate').textContent = new Date(data.ultimaActualizacion).toLocaleString();

          if (data.periodo) {
            document.getElementById('period').textContent = `${data.periodo.desde} - ${data.periodo.hasta}`;
          } else {
            document.getElementById('period').textContent = 'Un día';
          }
        } catch (error) {
          console.error('Error cargando estadísticas:', error);
        }
      }

      // Función para crear gráfica de tendencia
      function createChart(canvasId, url, history) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        // Destruir gráfica anterior si existe
        if (charts[canvasId]) {
          charts[canvasId].destroy();
        }

        // Ordenar por fecha
        const sortedHistory = [...history].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

        // Tomar últimas 10 ejecuciones
        const recentHistory = sortedHistory.slice(-10);

        const labels = recentHistory.map(h => `${h.fecha} ${h.hora}`);
        const vistas = recentHistory.map(h => h.vistas);
        const usuarios = recentHistory.map(h => h.usuarios);

        charts[canvasId] = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Vistas',
                data: vistas,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
              },
              {
                label: 'Usuarios',
                data: usuarios,
                borderColor: '#2ecc71',
                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
              },
            },
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      // Función para cargar URLs con historial
      async function loadUrls() {
        try {
          const response = await fetch('/api/urls');
          const data = await response.json();

          const content = document.getElementById('urlsContent');

          // Construir HTML con gráficas
          let html = `<h3>🔗 Resumen por URLs (${data.total} totales)</h3>`;

          for (const url of data.urls) {
            const lastExecution = url.ejecuciones[url.ejecuciones.length - 1];
            const chartId = `chart-${url.url.replace(/\//g, '-')}`;

            html += `
              <div class="url-item">
                <div class="url-title">${url.url}</div>
                <div class="url-stats">
                  <div class="url-stat">📊 ${lastExecution.vistas} vistas</div>
                  <div class="url-stat">👥 ${lastExecution.usuarios} usuarios</div>
                  <div class="url-stat">🔄 ${url.apariciones} ejecuciones</div>
                  <div class="url-stat ${url.tasaExito === 100 ? 'success' : 'warning'}">
                    ${url.tasaExito === 100 ? '✅' : '⚠️'} ${url.tasaExito}% éxito
                  </div>
                  <div class="url-stat">📈 ${url.promedioCompromiso}% compromiso</div>
                  <div class="url-stat">📉 ${url.promedioRebote}% rebote</div>
                </div>
                <div class="last-value">
                  Última ejecución: ${lastExecution.fecha} - ${lastExecution.vistas} vistas, ${
              lastExecution.sesiones
            } sesiones
                </div>
                <div class="chart-container">
                  <canvas id="${chartId}"></canvas>
                </div>
              </div>
            `;
          }

          content.innerHTML = html;

          // Crear gráficas después de que el DOM se actualice
          setTimeout(() => {
            data.urls.forEach(url => {
              const chartId = `chart-${url.url.replace(/\//g, '-')}`;
              createChart(chartId, url.url, url.ejecuciones);
            });
          }, 100);
        } catch (error) {
          document.getElementById(
            'urlsContent',
          ).innerHTML = `<div class="error">Error cargando URLs: ${error.message}</div>`;
        }
      }

      // Función para cargar ejecuciones
      async function loadExecutions() {
        try {
          const response = await fetch('/api/executions');
          const data = await response.json();

          const content = document.getElementById('executionsContent');
          content.innerHTML = `
            <h3>📋 Historial de ejecuciones (${data.total} totales)</h3>
            ${data.executions
              .reverse()
              .map(
                exec => `
                <div class="execution-item">
                  <div class="execution-meta">
                    <strong>${exec.fechaEjecucion} ${exec.horaEjecucion}</strong>
                    <span>${exec.urlsExitosas === exec.totalUrls ? '✅' : '⚠️'} ${exec.urlsConDatos}/${
                  exec.totalUrls
                } URLs con datos</span>
                  </div>
                  <div style="font-size: 14px; color: #7f8c8d;">
                    📁 ${exec.archivoOriginal} • ${exec.urlsProcessed} URLs procesadas
                  </div>
                </div>
              `,
              )
              .join('')}
          `;
        } catch (error) {
          document.getElementById(
            'executionsContent',
          ).innerHTML = `<div class="error">Error cargando ejecuciones: ${error.message}</div>`;
        }
      }

      // Inicializar dashboard
      async function init() {
        await loadStats();
        await loadUrls();

        if (currentTab === 'executions') {
          await loadExecutions();
        }
      }

      // Event listener para cambio de pestañas
      document.addEventListener('click', async e => {
        if (e.target.textContent.includes('Ejecuciones') && currentTab === 'executions') {
          await loadExecutions();
        }
      });

      // Inicializar cuando carga la página
      init();

      // Refrescar cada 30 segundos
      setInterval(init, 30000);
    </script>
  </body>
</html>
